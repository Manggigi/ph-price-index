<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PH Price Index ‚Äî Philippine Commodity Prices API</title>
<meta name="description" content="Free, open-source API for Philippine commodity prices. 33,800+ price records, 71 commodities, 8 years of data from the Department of Agriculture.">
<meta name="theme-color" content="#0D6E3A">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üáµüá≠</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--green:#0D6E3A;--green-light:#e8f5e9;--green-dark:#094d29;--blue:#0038A8;--red:#CE1126;--yellow:#FCD116;--bg:#f5f6f8;--card:#fff;--text:#1a1a2e;--text-secondary:#5f6368;--border:#e0e3e8;--radius:12px;--shadow:0 2px 12px rgba(0,0,0,.06);--shadow-lg:0 8px 30px rgba(0,0,0,.1);--transition:all .2s ease}
html{scroll-behavior:smooth}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}
a{color:var(--green);text-decoration:none}
a:hover{text-decoration:underline}

/* Layout */
.container{max-width:1200px;margin:0 auto;padding:0 20px}
section{padding:60px 0}
@media(max-width:768px){section{padding:40px 0}}

/* Nav */
nav{background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;backdrop-filter:blur(10px);background:rgba(255,255,255,.92)}
nav .container{display:flex;align-items:center;justify-content:space-between;height:56px}
nav .logo{font-weight:700;font-size:1.1rem;color:var(--green);display:flex;align-items:center;gap:8px}
nav .nav-links{display:flex;gap:24px;font-size:.9rem}
nav .nav-links a{color:var(--text-secondary);font-weight:500}
nav .nav-links a:hover{color:var(--green);text-decoration:none}
@media(max-width:600px){nav .nav-links{gap:12px;font-size:.8rem}}

/* Hero */
.hero{background:linear-gradient(135deg,var(--green) 0%,var(--green-dark) 100%);color:#fff;padding:80px 0 60px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-50%;right:-20%;width:500px;height:500px;background:radial-gradient(circle,rgba(255,255,255,.06) 0%,transparent 70%);border-radius:50%}
.hero h1{font-size:3rem;font-weight:800;letter-spacing:-.02em;margin-bottom:8px}
.hero .tagline{font-size:1.25rem;opacity:.9;margin-bottom:40px;font-weight:400}
.hero .flag-bar{display:flex;height:4px;width:200px;margin:0 auto 32px;border-radius:2px;overflow:hidden}
.hero .flag-bar span:nth-child(1){flex:1;background:var(--blue)}
.hero .flag-bar span:nth-child(2){flex:1;background:var(--red)}
.hero .flag-bar span:nth-child(3){flex:1;background:var(--yellow)}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;max-width:700px;margin:0 auto}
.stat-card{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.15);border-radius:var(--radius);padding:20px 12px;backdrop-filter:blur(10px)}
.stat-card .stat-num{font-size:2rem;font-weight:800;display:block;line-height:1.1}
.stat-card .stat-label{font-size:.8rem;opacity:.75;text-transform:uppercase;letter-spacing:.05em;margin-top:4px}
.stat-card .stat-num.loading{background:rgba(255,255,255,.2);border-radius:6px;display:inline-block;min-width:50px;min-height:32px;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@media(max-width:600px){.hero h1{font-size:2rem}.hero .tagline{font-size:1rem}.stats-grid{grid-template-columns:repeat(2,1fr);gap:10px}.stat-card .stat-num{font-size:1.5rem}}

/* Download Section */
.download-section{background:#fff;border-bottom:1px solid var(--border);text-align:center}
.download-section h2{font-size:1.8rem;font-weight:700;margin-bottom:8px}
.download-section .dl-desc{color:var(--text-secondary);margin-bottom:28px;font-size:1rem}
.download-btns{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:20px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:14px 28px;border-radius:var(--radius);font-weight:600;font-size:1rem;border:none;cursor:pointer;transition:var(--transition);text-decoration:none!important}
.btn-primary{background:var(--green);color:#fff}.btn-primary:hover{background:var(--green-dark);transform:translateY(-1px);box-shadow:var(--shadow-lg)}
.btn-outline{background:#fff;color:var(--green);border:2px solid var(--green)}.btn-outline:hover{background:var(--green-light);transform:translateY(-1px)}
.dl-meta{color:var(--text-secondary);font-size:.85rem}

/* Section Headers */
.section-header{text-align:center;margin-bottom:40px}
.section-header h2{font-size:1.8rem;font-weight:700;margin-bottom:8px}
.section-header p{color:var(--text-secondary);font-size:1.05rem}

/* Categories Grid */
.cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
.cat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden}
.cat-card:hover{border-color:var(--green);box-shadow:var(--shadow-lg);transform:translateY(-2px)}
.cat-card.active{border-color:var(--green);background:var(--green-light)}
.cat-card h3{font-size:1rem;font-weight:600;margin-bottom:8px;text-transform:capitalize}
.cat-card .cat-meta{display:flex;gap:16px;font-size:.8rem;color:var(--text-secondary)}
.cat-card .cat-meta span{display:flex;align-items:center;gap:4px}

/* Price Table Section */
.table-controls{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.search-box{flex:1;min-width:200px;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius);font-size:.95rem;transition:var(--transition);background:#fff}
.search-box:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(13,110,58,.12)}
input[type="date"]{padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius);font-size:.95rem;background:#fff;cursor:pointer}
input[type="date"]:focus{outline:none;border-color:var(--green)}

/* Filter Chips */
.chip-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.chip{padding:6px 14px;border-radius:20px;font-size:.8rem;font-weight:500;cursor:pointer;border:1px solid var(--border);background:#fff;color:var(--text-secondary);transition:var(--transition);white-space:nowrap}
.chip:hover{border-color:var(--green);color:var(--green)}
.chip.active{background:var(--green);color:#fff;border-color:var(--green)}

/* Table */
.table-wrap{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden}
.table-wrap table{width:100%;border-collapse:collapse}
.table-wrap th{background:var(--bg);padding:12px 16px;text-align:left;font-size:.8rem;text-transform:uppercase;letter-spacing:.04em;color:var(--text-secondary);font-weight:600;border-bottom:1px solid var(--border);position:sticky;top:0}
.table-wrap td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:.9rem}
.table-wrap tr:last-child td{border-bottom:none}
.table-wrap tr:hover td{background:var(--green-light);cursor:pointer}
.table-wrap .price-val{font-weight:700;color:var(--green);font-variant-numeric:tabular-nums}
.table-wrap .cat-badge{font-size:.7rem;padding:3px 8px;border-radius:10px;background:var(--bg);color:var(--text-secondary);font-weight:500;white-space:nowrap}
.table-scroll{max-height:600px;overflow-y:auto}
@media(max-width:768px){.table-wrap td,.table-wrap th{padding:10px 12px;font-size:.8rem}.table-controls{flex-direction:column}}

/* Pagination */
.pagination{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px;border-top:1px solid var(--border)}
.pagination button{padding:8px 14px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-size:.85rem;font-weight:500;transition:var(--transition)}
.pagination button:hover:not(:disabled){border-color:var(--green);color:var(--green)}
.pagination button:disabled{opacity:.4;cursor:not-allowed}
.pagination .page-info{font-size:.85rem;color:var(--text-secondary);margin:0 8px}

/* Chart Modal */
.chart-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .3s ease}
.chart-overlay.open{opacity:1;pointer-events:all}
.chart-panel{background:#fff;border-radius:var(--radius);width:100%;max-width:800px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);transform:translateY(20px);transition:transform .3s ease}
.chart-overlay.open .chart-panel{transform:translateY(0)}
.chart-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border)}
.chart-header h3{font-size:1.2rem;font-weight:700}
.chart-close{width:36px;height:36px;border:none;background:var(--bg);border-radius:50%;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.chart-close:hover{background:var(--red);color:#fff}
.chart-body{padding:24px}
.chart-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.chart-stat{text-align:center;padding:12px;background:var(--bg);border-radius:8px}
.chart-stat .cs-val{font-size:1.3rem;font-weight:700;color:var(--green)}
.chart-stat .cs-label{font-size:.75rem;color:var(--text-secondary);text-transform:uppercase}
.chart-loading{display:flex;align-items:center;justify-content:center;height:200px;color:var(--text-secondary)}

/* API Reference */
.api-section{background:#fff;border-bottom:1px solid var(--border)}
.endpoint-list{display:flex;flex-direction:column;gap:12px;max-width:800px;margin:0 auto}
.endpoint{display:flex;align-items:center;gap:12px;padding:14px 20px;background:var(--bg);border-radius:var(--radius);border:1px solid var(--border);transition:var(--transition);flex-wrap:wrap}
.endpoint:hover{border-color:var(--green);box-shadow:var(--shadow)}
.method-badge{background:var(--green);color:#fff;font-size:.7rem;font-weight:700;padding:4px 10px;border-radius:6px;letter-spacing:.04em;flex-shrink:0}
.endpoint-path{font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:.9rem;font-weight:600;color:var(--text);flex:1}
.endpoint-desc{font-size:.8rem;color:var(--text-secondary);width:100%;padding-left:56px;margin-top:2px}
.endpoint .try-link{font-size:.75rem;color:var(--green);font-weight:600;flex-shrink:0;text-transform:uppercase;letter-spacing:.04em}
@media(max-width:600px){.endpoint{flex-direction:column;align-items:flex-start;gap:6px}.endpoint-desc{padding-left:0}}

/* Footer */
footer{padding:40px 0;text-align:center;color:var(--text-secondary);font-size:.85rem}
footer .footer-links{display:flex;gap:24px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
footer .footer-links a{color:var(--text-secondary);font-weight:500}
footer .footer-links a:hover{color:var(--green)}
footer .flag-line{display:flex;height:3px;width:120px;margin:16px auto 0;border-radius:2px;overflow:hidden}
footer .flag-line span:nth-child(1){flex:1;background:var(--blue)}
footer .flag-line span:nth-child(2){flex:1;background:var(--red)}
footer .flag-line span:nth-child(3){flex:1;background:var(--yellow)}

/* Loading */
.skeleton{background:linear-gradient(90deg,#e8e8e8 25%,#f5f5f5 50%,#e8e8e8 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:6px;height:20px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:40px 20px;color:var(--text-secondary)}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--text);color:#fff;padding:12px 20px;border-radius:var(--radius);font-size:.9rem;z-index:300;transform:translateY(100px);opacity:0;transition:all .3s ease}
.toast.show{transform:translateY(0);opacity:1}
</style>
</head>
<body>

<!-- Nav -->
<nav>
  <div class="container">
    <div class="logo">üáµüá≠ PH Price Index</div>
    <div class="nav-links">
      <a href="#download">Download</a>
      <a href="#prices">Prices</a>
      <a href="#categories">Categories</a>
      <a href="#api">API</a>
      <a href="https://github.com/Manggigi/ph-price-index" target="_blank">GitHub</a>
    </div>
  </div>
</nav>

<!-- Hero -->
<section class="hero">
  <div class="container">
    <div class="flag-bar"><span></span><span></span><span></span></div>
    <h1>üáµüá≠ PH Price Index</h1>
    <p class="tagline">Free, open-source API for Philippine commodity prices</p>
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card"><span class="stat-num loading" id="statCommodities">&nbsp;</span><div class="stat-label">Commodities</div></div>
      <div class="stat-card"><span class="stat-num loading" id="statPrices">&nbsp;</span><div class="stat-label">Prices</div></div>
      <div class="stat-card"><span class="stat-num loading" id="statDates">&nbsp;</span><div class="stat-label">Dates</div></div>
      <div class="stat-card"><span class="stat-num loading" id="statCategories">&nbsp;</span><div class="stat-label">Categories</div></div>
    </div>
  </div>
</section>

<!-- Download -->
<section class="download-section" id="download">
  <div class="container">
    <h2>üì• Download All Data</h2>
    <p class="dl-desc">33,800+ price records ‚Ä¢ 71 commodities ‚Ä¢ 8 years of data ‚Äî one click download</p>
    <div class="download-btns">
      <a href="https://ph-price-index-production.up.railway.app/api/export/csv" class="btn btn-primary" download>üìÑ Download CSV</a>
      <a href="https://ph-price-index-production.up.railway.app/api/export/json" class="btn btn-outline" download>üìã Download JSON</a>
    </div>
    <p class="dl-meta">Source: Department of Agriculture ‚Äî Bureau of Agriculture and Fisheries Standards</p>
  </div>
</section>

<!-- Categories -->
<section id="categories">
  <div class="container">
    <div class="section-header">
      <h2>Categories</h2>
      <p>Browse commodities by category</p>
    </div>
    <div class="cat-grid" id="catGrid">
      <div class="skeleton" style="height:100px"></div>
      <div class="skeleton" style="height:100px"></div>
      <div class="skeleton" style="height:100px"></div>
      <div class="skeleton" style="height:100px"></div>
    </div>
  </div>
</section>

<!-- Prices -->
<section id="prices" style="background:#fff;border-top:1px solid var(--border);border-bottom:1px solid var(--border)">
  <div class="container">
    <div class="section-header">
      <h2>Live Price Table</h2>
      <p>Latest commodity prices from the Department of Agriculture</p>
    </div>
    <div class="table-controls">
      <input type="text" class="search-box" id="searchBox" placeholder="Search commodities...">
      <input type="date" id="datePicker">
    </div>
    <div class="chip-row" id="chipRow"></div>
    <div class="table-wrap">
      <div class="table-scroll" id="tableScroll">
        <table>
          <thead>
            <tr><th>Commodity</th><th>Specification</th><th>Category</th><th style="text-align:right">Price</th><th>Unit</th></tr>
          </thead>
          <tbody id="priceBody">
            <tr><td colspan="5"><div class="spinner" style="margin:40px auto"></div></td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
</section>

<!-- Chart Modal -->
<div class="chart-overlay" id="chartOverlay" onclick="if(event.target===this)closeChart()">
  <div class="chart-panel">
    <div class="chart-header">
      <h3 id="chartTitle">Price History</h3>
      <button class="chart-close" onclick="closeChart()">‚úï</button>
    </div>
    <div class="chart-body">
      <div class="chart-stats" id="chartStats"></div>
      <div id="chartContainer"><canvas id="priceChart"></canvas></div>
      <div class="chart-loading" id="chartLoading"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- API Reference -->
<section class="api-section" id="api">
  <div class="container">
    <div class="section-header">
      <h2>API Reference</h2>
      <p>RESTful JSON API ‚Äî free, no auth required &nbsp;‚Ä¢&nbsp; <a href="https://ph-price-index-production.up.railway.app/docs" target="_blank">Swagger Docs ‚Üó</a></p>
    </div>
    <div class="endpoint-list" id="endpointList"></div>
  </div>
</section>

<!-- Footer -->
<footer>
  <div class="container">
    <div class="footer-links">
      <a href="https://github.com/Manggigi/ph-price-index" target="_blank">GitHub</a>
      <a href="https://ph-price-index-production.up.railway.app/docs" target="_blank">API Docs</a>
      <a href="https://ph-price-index-production.up.railway.app/api/stats" target="_blank">Status</a>
    </div>
    <p>Data sourced from the <strong>Department of Agriculture</strong> ‚Äî Bureau of Agriculture and Fisheries Standards</p>
    <p style="margin-top:4px">MIT License ‚Ä¢ Built by <a href="https://github.com/Manggigi" target="_blank">@Manggigi</a></p>
    <div class="flag-line"><span></span><span></span><span></span></div>
  </div>
</footer>

<div class="toast" id="toast"></div>

<script>
const API = 'https://ph-price-index-production.up.railway.app';
let allCategories = [];
let activeCategory = null;
let currentPage = 1;
let currentDate = null;
let searchQuery = '';
let chartInstance = null;
let totalPages = 1;

// --- Init ---
document.addEventListener('DOMContentLoaded', () => {
  loadStats();
  loadCategories();
  loadLatestPrices();
  renderEndpoints();
  setupSearch();
});

// --- Stats ---
async function loadStats() {
  try {
    const res = await fetch(`${API}/api/stats`);
    const d = await res.json();
    setText('statCommodities', d.total_commodities);
    setText('statPrices', d.total_prices.toLocaleString());
    setText('statDates', d.total_dates.toLocaleString());
    setText('statCategories', d.total_categories);
    document.getElementById('datePicker').max = d.last_date;
    document.getElementById('datePicker').value = d.last_date;
    currentDate = d.last_date;
  } catch(e) {
    console.error('Stats error', e);
  }
}

function setText(id, val) {
  const el = document.getElementById(id);
  el.textContent = val;
  el.classList.remove('loading');
}

// --- Categories ---
async function loadCategories() {
  try {
    const res = await fetch(`${API}/api/categories`);
    const d = await res.json();
    allCategories = d.categories;
    renderCategoryGrid();
    renderChips();
  } catch(e) {
    document.getElementById('catGrid').innerHTML = '<p class="empty-state">Failed to load categories</p>';
  }
}

function renderCategoryGrid() {
  const grid = document.getElementById('catGrid');
  const icons = {'BEEF MEAT PRODUCTS':'ü•©','COOKING OIL':'ü´í','CORN PRODUCTS':'üåΩ','FISH PRODUCTS':'üêü','FROZEN PORK PRODUCTS':'üßä','FRUITS':'üçå','IMPORTED COMMERCIAL RICE':'üçö','OTHER LIVESTOCK MEAT':'üçñ','PORK MEAT PRODUCTS':'üêñ','SPICES':'üßÑ','VEGETABLES':'ü•¨'};
  grid.innerHTML = allCategories.map(c => `
    <div class="cat-card${activeCategory===c.category?' active':''}" onclick="filterCategory('${c.category.replace(/'/g,"\\'")}')">
      <h3>${icons[c.category]||'üì¶'} ${titleCase(c.category)}</h3>
      <div class="cat-meta">
        <span>${c.commodity_count} commodities</span>
        <span>${c.price_count.toLocaleString()} prices</span>
      </div>
    </div>`).join('');
}

function renderChips() {
  const row = document.getElementById('chipRow');
  row.innerHTML = `<span class="chip${!activeCategory?' active':''}" onclick="filterCategory(null)">All</span>` +
    allCategories.map(c => `<span class="chip${activeCategory===c.category?' active':''}" onclick="filterCategory('${c.category.replace(/'/g,"\\'")}')">` +
    titleCase(c.category) + '</span>').join('');
}

function filterCategory(cat) {
  activeCategory = activeCategory === cat ? null : cat;
  currentPage = 1;
  renderCategoryGrid();
  renderChips();
  loadPriceTable();
  document.getElementById('prices').scrollIntoView({behavior:'smooth',block:'start'});
}

// --- Prices ---
async function loadLatestPrices() {
  try {
    const res = await fetch(`${API}/api/prices/latest?limit=200`);
    const d = await res.json();
    currentDate = d.date;
    document.getElementById('datePicker').value = d.date;
    renderTable(d.prices, d);
  } catch(e) {
    document.getElementById('priceBody').innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load prices</td></tr>';
  }
}

async function loadPriceTable() {
  const body = document.getElementById('priceBody');
  body.innerHTML = '<tr><td colspan="5"><div class="spinner" style="margin:40px auto"></div></td></tr>';

  try {
    let url, data;
    if (searchQuery) {
      url = `${API}/api/search?q=${encodeURIComponent(searchQuery)}`;
      const res = await fetch(url);
      data = await res.json();
      renderTable(data.results || [], data);
      return;
    }
    url = `${API}/api/prices/${currentDate}?page=${currentPage}&limit=200`;
    const res = await fetch(url);
    data = await res.json();
    let prices = data.prices || [];
    if (activeCategory) prices = prices.filter(p => p.category === activeCategory);
    totalPages = data.meta ? data.meta.total_pages : 1;
    renderTable(prices, data);
  } catch(e) {
    body.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading prices</td></tr>';
  }
}

function renderTable(prices, meta) {
  const body = document.getElementById('priceBody');
  if (!prices.length) {
    body.innerHTML = '<tr><td colspan="5" class="empty-state">No prices found</td></tr>';
    document.getElementById('pagination').innerHTML = '';
    return;
  }
  body.innerHTML = prices.map(p => `
    <tr onclick="showChart('${p.name.replace(/'/g,"\\'")}')">
      <td><strong>${p.name}</strong></td>
      <td>${p.specification || '‚Äî'}</td>
      <td><span class="cat-badge">${titleCase(p.category)}</span></td>
      <td style="text-align:right" class="price-val">‚Ç±${p.price.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td>${p.unit}</td>
    </tr>`).join('');

  // Pagination
  const pg = document.getElementById('pagination');
  if (meta && meta.meta && meta.meta.total_pages > 1) {
    pg.innerHTML = `
      <button onclick="changePage(-1)" ${currentPage<=1?'disabled':''}>‚Üê Prev</button>
      <span class="page-info">Page ${meta.meta.page} of ${meta.meta.total_pages}</span>
      <button onclick="changePage(1)" ${currentPage>=meta.meta.total_pages?'disabled':''}>Next ‚Üí</button>`;
  } else {
    pg.innerHTML = '';
  }
}

function changePage(dir) {
  currentPage += dir;
  loadPriceTable();
}

// --- Search ---
function setupSearch() {
  let timer;
  document.getElementById('searchBox').addEventListener('input', e => {
    clearTimeout(timer);
    searchQuery = e.target.value.trim();
    timer = setTimeout(() => { currentPage = 1; loadPriceTable(); }, 400);
  });
  document.getElementById('datePicker').addEventListener('change', e => {
    currentDate = e.target.value;
    searchQuery = '';
    document.getElementById('searchBox').value = '';
    currentPage = 1;
    loadPriceTable();
  });
}

// --- Chart ---
async function showChart(name) {
  const overlay = document.getElementById('chartOverlay');
  const loading = document.getElementById('chartLoading');
  const container = document.getElementById('chartContainer');
  const stats = document.getElementById('chartStats');
  document.getElementById('chartTitle').textContent = name;
  overlay.classList.add('open');
  loading.style.display = 'flex';
  container.style.display = 'none';
  stats.innerHTML = '';

  try {
    const res = await fetch(`${API}/api/commodities/${encodeURIComponent(name)}/history?days=730`);
    const d = await res.json();
    const history = d.history || [];
    if (!history.length) { loading.innerHTML = '<p>No history data</p>'; return; }

    const prices = history.map(h => h.price);
    const avg = prices.reduce((a,b) => a+b, 0) / prices.length;
    const current = prices[prices.length - 1];
    const min = Math.min(...prices);
    const max = Math.max(...prices);

    stats.innerHTML = `
      <div class="chart-stat"><div class="cs-val">‚Ç±${current.toFixed(2)}</div><div class="cs-label">Latest</div></div>
      <div class="chart-stat"><div class="cs-val">‚Ç±${avg.toFixed(2)}</div><div class="cs-label">Average</div></div>
      <div class="chart-stat"><div class="cs-val">‚Ç±${min.toFixed(2)} ‚Äì ‚Ç±${max.toFixed(2)}</div><div class="cs-label">Range</div></div>`;

    loading.style.display = 'none';
    container.style.display = 'block';

    if (chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('priceChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: history.map(h => h.date),
        datasets: [{
          label: `${name} (PHP/kg)`,
          data: prices,
          borderColor: '#0D6E3A',
          backgroundColor: 'rgba(13,110,58,.08)',
          fill: true,
          tension: .3,
          pointRadius: 0,
          pointHitRadius: 10,
          borderWidth: 2.5
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `‚Ç±${ctx.parsed.y.toFixed(2)}`
            }
          }
        },
        scales: {
          x: { ticks: { maxTicksLimit: 8, font: {size: 11} }, grid: { display: false } },
          y: { ticks: { callback: v => '‚Ç±' + v, font: {size: 11} }, grid: { color: '#f0f0f0' } }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    });
  } catch(e) {
    loading.innerHTML = '<p>Failed to load chart data</p>';
  }
}

function closeChart() {
  document.getElementById('chartOverlay').classList.remove('open');
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeChart(); });

// --- API Endpoints ---
function renderEndpoints() {
  const endpoints = [
    { path: '/api/stats', desc: 'Database statistics ‚Äî commodity count, price count, date range' },
    { path: '/api/categories', desc: 'All categories with commodity counts and date ranges' },
    { path: '/api/commodities', desc: 'List all tracked commodities' },
    { path: '/api/commodities/{name}', desc: 'Details for a specific commodity', example: '/api/commodities/Rice (Regular Milled)' },
    { path: '/api/commodities/{name}/history', desc: 'Price history for a commodity ‚Äî supports ?days=N or ?from=&to=', example: '/api/commodities/Rice (Regular Milled)/history?days=30' },
    { path: '/api/prices/latest', desc: 'Latest prices for all commodities', example: '/api/prices/latest' },
    { path: '/api/prices/{date}', desc: 'Prices for a specific date ‚Äî supports ?page=&limit=', example: '/api/prices/2026-02-08' },
    { path: '/api/prices/range', desc: 'Prices across a date range ‚Äî ?from=&to=&commodity=', example: '/api/prices/range?from=2025-01-01&to=2025-12-31&commodity=Galunggong' },
    { path: '/api/search', desc: 'Search commodities by name ‚Äî ?q=keyword', example: '/api/search?q=rice' },
    { path: '/api/dates', desc: 'All available dates in the dataset' },
    { path: '/api/export/csv', desc: 'Download entire dataset as CSV' },
    { path: '/api/export/json', desc: 'Download entire dataset as JSON' },
  ];
  document.getElementById('endpointList').innerHTML = endpoints.map(e => `
    <div class="endpoint">
      <span class="method-badge">GET</span>
      <span class="endpoint-path">${e.path}</span>
      ${e.example ? `<a href="${API}${e.example}" target="_blank" class="try-link">Try it ‚Üó</a>` : ''}
      <span class="endpoint-desc">${e.desc}</span>
    </div>`).join('');
}

// --- Util ---
function titleCase(s) {
  return s.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
